{% extends "base.html" %}

{% block title %}Quotes - Nicayne Metal Processing{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div style="background: linear-gradient(135deg, #005baa, #0080d4); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 style="margin: 0; font-size: 2.5rem; font-weight: bold;">Create Quote</h1>
                        <p style="margin: 10px 0 0 0; font-size: 1.1rem; opacity: 0.9;">Quote form with AI extraction and lifecycle tracking</p>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="/quotes" class="nmp-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">Dashboard</a>
                        <a href="/quotes/form" class="nmp-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">Create Quote</a>
                    </div>
                </div>
            </div>



            <!-- Quote Creation Section -->
            <div style="background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px; overflow: hidden;">
                <div style="background: #005baa; color: white; padding: 15px 20px; font-weight: bold; font-size: 1.1rem;">
                    Create New Quote
                </div>
                <div style="padding: 30px;">
                    <form id="quoteForm">
                        <!-- General Information -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #005baa; margin-bottom: 20px; border-bottom: 2px solid #005baa; padding-bottom: 10px;">General Information</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Quote Number</label>
                                    <input type="text" id="quoteNumber" name="quote_number" class="nmp-form-control" readonly>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Customer Name</label>
                                    <input type="text" id="customerName" name="customer_name" class="nmp-form-control" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Quote Date</label>
                                    <input type="date" id="quoteDate" name="quote_date" class="nmp-form-control" required>
                                </div>

                            </div>
                            
                            <!-- Additional Job Information Fields -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Max Bundle/Skid Weight (lbs)</label>
                                    <input type="number" id="maxBundleWeight" name="max_bundle_weight" class="nmp-form-control" step="1" min="0" placeholder="Enter max weight">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Requested Pieces per Bundle</label>
                                    <input type="number" id="piecesPerBundle" name="pieces_per_bundle" class="nmp-form-control" step="1" min="1" placeholder="Enter pieces">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Max Outside Diameter (OD) (in)</label>
                                    <input type="number" id="maxOD" name="max_od" class="nmp-form-control" step="0.1" min="0" placeholder="Enter OD">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Coil Direction on Skid</label>
                                    <select id="coilDirection" name="coil_direction" class="nmp-form-control">
                                        <option value="">Select Direction</option>
                                        <option value="CW">CW (Clockwise)</option>
                                        <option value="CCW">CCW (Counter-Clockwise)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Toggle Options -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Split Coil</label>
                                    <div style="display: flex; gap: 15px;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="split_coil" value="yes" style="margin: 0;">
                                            <span>Yes</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="split_coil" value="no" style="margin: 0;">
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Wood Spacers</label>
                                    <div style="display: flex; gap: 15px;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="wood_spacers" value="yes" style="margin: 0;">
                                            <span>Yes</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="wood_spacers" value="no" style="margin: 0;">
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Paper Wrap</label>
                                    <div style="display: flex; gap: 15px;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="paper_wrap" value="yes" style="margin: 0;">
                                            <span>Yes</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="paper_wrap" value="no" style="margin: 0;">
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Edge Protectors</label>
                                    <div style="display: flex; gap: 15px;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="edge_protectors" value="yes" style="margin: 0;">
                                            <span>Yes</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="radio" name="edge_protectors" value="no" style="margin: 0;">
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Tolerances Section -->
                            <div style="margin-top: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <label style="font-weight: 600; color: #333; font-size: 1.1rem;">Tolerances</label>
                                    <button type="button" onclick="addTolerance()" class="nmp-btn" style="background: #28a745; padding: 8px 15px; font-size: 0.9rem;">Add Tolerance Group</button>
                                </div>
                                <div id="tolerances" style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 60px;">
                                    <div class="tolerance-group" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Thickness Tolerance</label>
                                                <input type="text" name="tolerance_thickness[]" class="nmp-form-control" placeholder="e.g., ±0.001&quot;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Width Tolerance</label>
                                                <input type="text" name="tolerance_width[]" class="nmp-form-control" placeholder="e.g., ±0.005&quot;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Length Tolerance</label>
                                                <input type="text" name="tolerance_length[]" class="nmp-form-control" placeholder="e.g., ±0.010&quot;">
                                            </div>
                                            <button type="button" onclick="removeTolerance(this)" class="nmp-btn" style="background: #dc3545; padding: 10px;">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Packaging Instructions/Customer Request</label>
                                <textarea id="packagingInstructions" name="packaging_instructions" class="nmp-form-control" rows="3" placeholder="Enter packaging instructions or customer-specific requirements..."></textarea>
                            </div>
                        </div>

                        <!-- Process Type Selection -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #005baa; margin-bottom: 20px; border-bottom: 2px solid #005baa; padding-bottom: 10px;">Process Type</h4>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Select Process Type</label>
                                <select id="processType" name="process_type" class="nmp-form-control" onchange="toggleQuoteJobSections(this)" required>
                                    <option value="">Select Process Type</option>
                                    <option value="slitting">Slitting</option>
                                    <option value="cut_to_length">Cut to Length</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                        </div>

                        <!-- Slitting Jobs Section -->
                        <div id="slittingSection" style="margin-bottom: 30px; display: none;">
                            <h4 style="color: #005baa; margin-bottom: 20px; border-bottom: 2px solid #005baa; padding-bottom: 10px;">Slitting Jobs</h4>
                            <div id="slittingJobs">
                                <div class="slitting-job" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Material Grade</label>
                                            <input type="text" name="slitting_material_grade[]" class="nmp-form-control" placeholder="e.g., A1008">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Coil Description</label>
                                            <input type="text" name="slitting_coil_description[]" class="nmp-form-control" placeholder="e.g., 0.250 x 25 x Coil">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Incoming Coils</label>
                                            <input type="number" name="slitting_incoming_coils[]" class="nmp-form-control slitting-incoming-coils" min="1" placeholder="1">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Incoming Weight (lbs)</label>
                                            <input type="number" name="slitting_incoming_weight[]" class="nmp-form-control slitting-incoming-weight" step="0.1" min="0" placeholder="20000">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">OD (in)</label>
                                            <input type="number" name="slitting_od[]" class="nmp-form-control slitting-od" step="0.1" readonly>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">PIW (lbs/in)</label>
                                            <input type="number" name="slitting_piw[]" class="nmp-form-control slitting-piw" step="0.1" readonly>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Slitter Setup</label>
                                            <textarea name="slitting_setup[]" class="nmp-form-control" rows="2" placeholder="e.g., 6 x 4.166&quot; + 2 x 0.333&quot; trim"></textarea>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Number of Skids</label>
                                            <input type="number" name="slitting_skids[]" class="nmp-form-control" min="1" placeholder="1">
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <button type="button" onclick="removeSlittingJob(this)" class="nmp-btn" style="background: #dc3545;">Remove Job</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="addSlittingJob()" class="nmp-btn" style="background: #28a745;">Add Slitting Job</button>
                        </div>

                        <!-- Cut to Length Jobs Section -->
                        <div id="ctlSection" style="margin-bottom: 30px; display: none;">
                            <h4 style="color: #005baa; margin-bottom: 20px; border-bottom: 2px solid #005baa; padding-bottom: 10px;">Cut to Length Jobs</h4>
                            <div id="ctlJobs">
                                <div class="ctl-job" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Material Grade</label>
                                            <input type="text" name="ctl_material_grade[]" class="nmp-form-control" placeholder="e.g., A1008">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Material Description</label>
                                            <input type="text" name="ctl_material_description[]" class="nmp-form-control ctl-description" placeholder="e.g., .250 x 4 x 240">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Number of Incoming Coils</label>
                                            <input type="number" name="ctl_incoming_coils[]" class="nmp-form-control" min="1" placeholder="1">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Incoming Weight (lbs)</label>
                                            <input type="number" name="ctl_incoming_weight[]" class="nmp-form-control ctl-incoming-weight" step="0.1" min="0" placeholder="20000">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Finished Pieces</label>
                                            <input type="number" name="ctl_finished_pieces[]" class="nmp-form-control ctl-finished-pieces" readonly placeholder="Auto-calculated">
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <button type="button" onclick="removeCTLJob(this)" class="nmp-btn" style="background: #dc3545;">Remove Job</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="addCTLJob()" class="nmp-btn" style="background: #28a745;">Add Cut to Length Job</button>
                        </div>

                        <!-- Pricing Information -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #005baa; margin-bottom: 20px; border-bottom: 2px solid #005baa; padding-bottom: 10px;">Pricing Information</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Pricing Method</label>
                                    <select id="pricingMethod" name="pricing_method" class="nmp-form-control" required>
                                        <option value="">Select Method</option>
                                        <option value="Per Ton">Per Ton</option>
                                        <option value="Per Piece">Per Piece</option>
                                        <option value="Flat Rate">Flat Rate</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Unit Price ($)</label>
                                    <input type="number" id="unitPrice" name="unit_price" class="nmp-form-control" step="0.01" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- AI Extraction Section -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #005baa; margin-bottom: 20px; border-bottom: 2px solid #005baa; padding-bottom: 10px;">AI Extraction</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Extract from Email Text</label>
                                    <textarea id="emailText" class="nmp-form-control" rows="4" placeholder="Paste email content here for AI extraction..."></textarea>
                                    <button type="button" onclick="extractFromText()" class="nmp-btn" style="margin-top: 10px;">Extract from Text</button>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Upload File for Extraction</label>
                                    <input type="file" id="extractFile" accept=".pdf,.doc,.docx,.txt" class="nmp-form-control">
                                    <button type="button" onclick="extractFromFile()" class="nmp-btn" style="margin-top: 10px;">Extract from File</button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="text-align: center; padding-top: 20px; border-top: 1px solid #ddd;">
                            <button type="submit" class="nmp-btn" style="background: #28a745; margin-right: 15px;">Create Quote</button>
                            <button type="button" onclick="clearForm()" class="nmp-btn" style="background: #6c757d;">Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quotes Table Section -->
            <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                <div style="background: #005baa; color: white; padding: 15px 20px; font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center;">
                    <span>Recent Quotes (Last 30 Days)</span>
                    <div>
                        <input type="text" id="searchQuotes" placeholder="Search quotes..." style="padding: 5px 10px; border: none; border-radius: 4px; margin-right: 10px;">
                        <select id="statusFilter" style="padding: 5px 10px; border: none; border-radius: 4px;">
                            <option value="">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Realized">Realized</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div id="quotesTableContainer" style="padding: 20px;">
                    <div style="text-align: center; padding: 40px; color: #666;">Loading quotes...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    generateQuoteNumber();
    setDefaultDates();
    loadQuotes();
    setupEventListeners();
});

function generateQuoteNumber() {
    const now = new Date();
    const year = now.getFullYear().toString().substr(-2);
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
    const quoteNumber = `Q${year}${month}${day}-${time}`;
    document.getElementById('quoteNumber').value = quoteNumber;
}

function setDefaultDates() {
    const today = new Date();
    const validUntil = new Date();
    validUntil.setDate(today.getDate() + 30); // 30 days from today
    
    document.getElementById('quoteDate').value = today.toISOString().split('T')[0];
    document.getElementById('quoteValidUntil').value = validUntil.toISOString().split('T')[0];
}

function addSlittingJob() {
    const container = document.getElementById('slittingJobs');
    const jobHtml = `
        <div class="slitting-job" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Width (in)</label>
                    <input type="number" class="nmp-form-control slitting-width" step="0.001" min="0" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Length (ft)</label>
                    <input type="number" class="nmp-form-control slitting-length" step="0.1" min="0" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Thickness (in)</label>
                    <input type="number" class="nmp-form-control slitting-thickness" step="0.001" min="0" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Pieces</label>
                    <input type="number" class="nmp-form-control slitting-pieces" min="1" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Weight (lbs)</label>
                    <input type="number" class="nmp-form-control slitting-weight" readonly>
                </div>
                <div style="display: flex; align-items: end;">
                    <button type="button" onclick="removeSlittingJob(this)" class="nmp-btn" style="background: #dc3545; width: 100%;">Remove</button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', jobHtml);
}

function removeSlittingJob(button) {
    button.closest('.slitting-job').remove();
}

function addCTLJob() {
    const container = document.getElementById('ctlJobs');
    const jobHtml = `
        <div class="ctl-job" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Width (in)</label>
                    <input type="number" class="nmp-form-control ctl-width" step="0.001" min="0" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Length (ft)</label>
                    <input type="number" class="nmp-form-control ctl-length" step="0.1" min="0" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Thickness (in)</label>
                    <input type="number" class="nmp-form-control ctl-thickness" step="0.001" min="0" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Pieces</label>
                    <input type="number" class="nmp-form-control ctl-pieces" min="1" onchange="calculateWeight(this)">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Weight (lbs)</label>
                    <input type="number" class="nmp-form-control ctl-weight" readonly>
                </div>
                <div style="display: flex; align-items: end;">
                    <button type="button" onclick="removeCTLJob(this)" class="nmp-btn" style="background: #dc3545; width: 100%;">Remove</button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', jobHtml);
}

function removeCTLJob(button) {
    button.closest('.ctl-job').remove();
}

function calculateWeight(element) {
    const job = element.closest('.slitting-job, .ctl-job');
    const isSlitting = job.classList.contains('slitting-job');
    
    const width = parseFloat(job.querySelector(isSlitting ? '.slitting-width' : '.ctl-width').value) || 0;
    const length = parseFloat(job.querySelector(isSlitting ? '.slitting-length' : '.ctl-length').value) || 0;
    const thickness = parseFloat(job.querySelector(isSlitting ? '.slitting-thickness' : '.ctl-thickness').value) || 0;
    const pieces = parseInt(job.querySelector(isSlitting ? '.slitting-pieces' : '.ctl-pieces').value) || 0;
    
    if (width && length && thickness && pieces) {
        // Steel density: 0.2836 lb/in³
        const volume = width * (length * 12) * thickness; // Convert feet to inches
        const weight = Math.round(volume * 0.2836 * pieces);
        job.querySelector(isSlitting ? '.slitting-weight' : '.ctl-weight').value = weight;
    }
}

function addTolerance() {
    const container = document.getElementById('tolerances');
    const toleranceHtml = `
        <div class="tolerance-group" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Thickness Tolerance</label>
                    <input type="text" name="tolerance_thickness[]" class="nmp-form-control" placeholder="e.g., ±0.001&quot;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Width Tolerance</label>
                    <input type="text" name="tolerance_width[]" class="nmp-form-control" placeholder="e.g., ±0.005&quot;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Length Tolerance</label>
                    <input type="text" name="tolerance_length[]" class="nmp-form-control" placeholder="e.g., ±0.010&quot;">
                </div>
                <button type="button" onclick="removeTolerance(this)" class="nmp-btn" style="background: #dc3545; padding: 10px;">Remove</button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', toleranceHtml);
}

function removeTolerance(button) {
    button.closest('.tolerance-group').remove();
}

function setupEventListeners() {
    // Form submission
    document.getElementById('quoteForm').addEventListener('submit', handleQuoteSubmission);
    
    // Search and filter
    document.getElementById('searchQuotes').addEventListener('input', filterQuotes);
    document.getElementById('statusFilter').addEventListener('change', filterQuotes);
}

function handleQuoteSubmission(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const quoteData = Object.fromEntries(formData.entries());
    
    // Add empty arrays for job data
    quoteData.slitting_jobs = [];
    quoteData.cut_to_length_jobs = [];
    
    fetch('/create-quote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(quoteData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Quote created successfully!');
            clearForm();
            loadQuotes();
        } else {
            alert('Error creating quote: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating quote');
    });
}

function loadQuotes() {
    fetch('/api/get-quotes')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayQuotes(data.quotes);
            updateStatistics(data.quotes);
        } else {
            document.getElementById('quotesTableContainer').innerHTML = 
                '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading quotes: ' + data.error + '</div>';
        }
    })
    .catch(error => {
        console.error('Error loading quotes:', error);
        document.getElementById('quotesTableContainer').innerHTML = 
            '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading quotes</div>';
    });
}

function displayQuotes(quotes) {
    const container = document.getElementById('quotesTableContainer');
    
    if (quotes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                <h4>No quotes found</h4>
                <p>Create your first quote using the form above.</p>
            </div>
        `;
        return;
    }
    
    let tableHTML = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #005baa;">
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Quote #</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Customer</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Date Created</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Process Type</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Unit Price</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    quotes.forEach(quote => {
        const statusColor = quote.status === 'Active' ? '#28a745' : 
                           quote.status === 'Realized' ? '#007bff' : '#6c757d';
        
        tableHTML += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 12px; font-weight: 600;">${quote.quote_number}</td>
                <td style="padding: 12px;">${quote.customer_name}</td>
                <td style="padding: 12px;">${new Date(quote.date_created).toLocaleDateString()}</td>
                <td style="padding: 12px;">${quote.process_type}</td>
                <td style="padding: 12px;">
                    <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                        ${quote.status}
                    </span>
                </td>
                <td style="padding: 12px;">$${quote.unit_price || '0.00'}</td>
                <td style="padding: 12px; text-align: center;">
                    <button onclick="viewQuote('${quote.quote_number}')" class="nmp-btn" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">View</button>
                    <button onclick="editQuote('${quote.quote_number}')" class="nmp-btn" style="padding: 5px 10px; font-size: 0.8rem; background: #ffc107;">Edit</button>
                </td>
            </tr>
        `;
    });
    
    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;
}

function updateStatistics(quotes) {
    const stats = {
        active: quotes.filter(q => q.status === 'Active').length,
        realized: quotes.filter(q => q.status === 'Realized').length,
        inactive: quotes.filter(q => q.status === 'Inactive').length,
        totalValue: quotes.reduce((sum, q) => sum + (parseFloat(q.unit_price) || 0), 0)
    };
    
    document.getElementById('activeQuotes').textContent = stats.active;
    document.getElementById('realizedQuotes').textContent = stats.realized;
    document.getElementById('inactiveQuotes').textContent = stats.inactive;
    document.getElementById('totalQuoteValue').textContent = '$' + stats.totalValue.toFixed(2);
}

function filterQuotes() {
    // Implement search and filter functionality
    loadQuotes(); // For now, reload all quotes
}

function clearForm() {
    document.getElementById('quoteForm').reset();
    generateQuoteNumber();
}

function extractFromText() {
    const text = document.getElementById('emailText').value;
    if (!text.trim()) {
        alert('Please enter some text to extract from');
        return;
    }
    
    fetch('/extract-quote-from-text', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateFormFromExtraction(data.extracted_data);
        } else {
            alert('Error extracting data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error extracting data from text');
    });
}

function extractFromFile() {
    const fileInput = document.getElementById('extractFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to extract from');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/extract-quote-from-file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateFormFromExtraction(data.extracted_data);
        } else {
            alert('Error extracting data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error extracting data from file');
    });
}

function populateFormFromExtraction(data) {
    if (data.customer_name) document.getElementById('customerName').value = data.customer_name;
    if (data.process_type) document.getElementById('processType').value = data.process_type;
    if (data.pricing_method) document.getElementById('pricingMethod').value = data.pricing_method;
    if (data.unit_price) document.getElementById('unitPrice').value = data.unit_price;
    if (data.packaging_instructions) document.getElementById('packagingInstructions').value = data.packaging_instructions;
}

function viewQuote(quoteNumber) {
    // Implement quote viewing functionality
    alert('View quote: ' + quoteNumber);
}

function editQuote(quoteNumber) {
    // Implement quote editing functionality  
    alert('Edit quote: ' + quoteNumber);
}

// Slitting Job Functions
function addSlittingJob() {
    const container = document.getElementById('slittingJobs');
    const jobHtml = `
        <div class="slitting-job" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Material Grade</label>
                    <input type="text" name="slitting_material_grade[]" class="nmp-form-control" placeholder="e.g., A1008">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Coil Description</label>
                    <input type="text" name="slitting_coil_description[]" class="nmp-form-control" placeholder="e.g., 0.250 x 25 x Coil">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Incoming Coils</label>
                    <input type="number" name="slitting_incoming_coils[]" class="nmp-form-control slitting-incoming-coils" min="1" placeholder="1">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Incoming Weight (lbs)</label>
                    <input type="number" name="slitting_incoming_weight[]" class="nmp-form-control slitting-incoming-weight" step="0.1" min="0" placeholder="20000">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">OD (in)</label>
                    <input type="number" name="slitting_od[]" class="nmp-form-control slitting-od" step="0.1" readonly>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">PIW (lbs/in)</label>
                    <input type="number" name="slitting_piw[]" class="nmp-form-control slitting-piw" step="0.1" readonly>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Slitter Setup</label>
                    <textarea name="slitting_setup[]" class="nmp-form-control" rows="2" placeholder="e.g., 6 x 4.166&quot; + 2 x 0.333&quot; trim"></textarea>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Number of Skids</label>
                    <input type="number" name="slitting_skids[]" class="nmp-form-control" min="1" placeholder="1">
                </div>
            </div>
            <div style="text-align: right;">
                <button type="button" onclick="removeSlittingJob(this)" class="nmp-btn" style="background: #dc3545;">Remove Job</button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', jobHtml);
    setupSlittingJobEventListeners(container.lastElementChild);
}

function removeSlittingJob(button) {
    const jobContainer = button.closest('.slitting-job');
    jobContainer.remove();
}

function setupSlittingJobEventListeners(jobContainer) {
    const incomingWeightInput = jobContainer.querySelector('.slitting-incoming-weight');
    const incomingCoilsInput = jobContainer.querySelector('.slitting-incoming-coils');
    
    if (incomingWeightInput) {
        incomingWeightInput.addEventListener('input', () => calculateSlittingOD(jobContainer));
    }
    if (incomingCoilsInput) {
        incomingCoilsInput.addEventListener('input', () => calculateSlittingOD(jobContainer));
    }
}

function calculateSlittingOD(jobContainer) {
    const incomingWeight = parseFloat(jobContainer.querySelector('.slitting-incoming-weight').value) || 0;
    const incomingCoils = parseFloat(jobContainer.querySelector('.slitting-incoming-coils').value) || 1;
    
    if (incomingWeight > 0) {
        // Steel coil OD calculation (simplified formula)
        const weightPerCoil = incomingWeight / incomingCoils;
        const od = Math.sqrt(weightPerCoil * 0.0015) + 20; // Simplified OD calculation
        const piw = weightPerCoil / 25; // Simplified PIW calculation (weight per inch of width)
        
        jobContainer.querySelector('.slitting-od').value = Math.round(od * 10) / 10;
        jobContainer.querySelector('.slitting-piw').value = Math.round(piw * 10) / 10;
    }
}

// Cut-to-Length Job Functions
function addCTLJob() {
    const container = document.getElementById('ctlJobs');
    const jobHtml = `
        <div class="ctl-job" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Material Grade</label>
                    <input type="text" name="ctl_material_grade[]" class="nmp-form-control" placeholder="e.g., A1008">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Material Description</label>
                    <input type="text" name="ctl_material_description[]" class="nmp-form-control ctl-description" placeholder="e.g., .250 x 4 x 240">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Number of Incoming Coils</label>
                    <input type="number" name="ctl_incoming_coils[]" class="nmp-form-control" min="1" placeholder="1">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Incoming Weight (lbs)</label>
                    <input type="number" name="ctl_incoming_weight[]" class="nmp-form-control ctl-incoming-weight" step="0.1" min="0" placeholder="20000">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Finished Pieces</label>
                    <input type="number" name="ctl_finished_pieces[]" class="nmp-form-control ctl-finished-pieces" readonly placeholder="Auto-calculated">
                </div>
            </div>
            <div style="text-align: right;">
                <button type="button" onclick="removeCTLJob(this)" class="nmp-btn" style="background: #dc3545;">Remove Job</button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', jobHtml);
    setupCTLJobEventListeners(container.lastElementChild);
}

function removeCTLJob(button) {
    const jobContainer = button.closest('.ctl-job');
    jobContainer.remove();
}

function setupCTLJobEventListeners(jobContainer) {
    const materialDescriptionInput = jobContainer.querySelector('.ctl-description');
    const incomingWeightInput = jobContainer.querySelector('.ctl-incoming-weight');
    
    [materialDescriptionInput, incomingWeightInput].forEach(input => {
        if (input) {
            input.addEventListener('input', () => calculateCTLData(jobContainer));
        }
    });
}

function calculateCTLData(jobContainer) {
    const materialDescription = jobContainer.querySelector('.ctl-description').value || '';
    const incomingWeight = parseFloat(jobContainer.querySelector('.ctl-incoming-weight').value) || 0;
    
    // Parse material description to extract dimensions
    // Expected format: .250 x 4 x 240 or 0.250 x 4 x 240
    const dimensionMatch = materialDescription.match(/(\d*\.?\d+)\s*x\s*(\d*\.?\d+)\s*x\s*(\d*\.?\d+)/i);
    
    if (dimensionMatch && incomingWeight > 0) {
        const thickness = parseFloat(dimensionMatch[1]);
        const width = parseFloat(dimensionMatch[2]);
        const length = parseFloat(dimensionMatch[3]);
        
        if (thickness > 0 && width > 0 && length > 0) {
            const steelDensity = 0.2836; // lb/in³
            const volumePerPiece = thickness * width * length;
            const weightPerPiece = volumePerPiece * steelDensity;
            const finishedPieces = Math.round(incomingWeight / weightPerPiece);
            
            jobContainer.querySelector('.ctl-finished-pieces').value = finishedPieces;
        } else {
            jobContainer.querySelector('.ctl-finished-pieces').value = '';
        }
    } else {
        jobContainer.querySelector('.ctl-finished-pieces').value = '';
    }
}

// Process Type Toggle Function - Pass dropdown element directly
window.toggleQuoteJobSections = function(selectElement) {
    console.log('toggleQuoteJobSections called with element:', selectElement); // Debug log
    
    const processType = selectElement ? selectElement.value : '';
    console.log('Selected process type:', processType); // Debug log
    
    const slittingSection = document.getElementById('slittingSection');
    const ctlSection = document.getElementById('ctlSection');
    
    if (!slittingSection || !ctlSection) {
        console.error('Could not find job sections');
        return;
    }
    
    // Hide all sections first
    slittingSection.style.display = 'none';
    ctlSection.style.display = 'none';
    
    // Clear existing jobs when switching process types
    const slittingJobs = document.getElementById('slittingJobs');
    const ctlJobs = document.getElementById('ctlJobs');
    if (slittingJobs) slittingJobs.innerHTML = '';
    if (ctlJobs) ctlJobs.innerHTML = '';
    
    // Show appropriate sections based on selection
    if (processType === 'slitting') {
        console.log('Showing slitting section');
        slittingSection.style.display = 'block';
        addSlittingJob(); // Add one default job
    } else if (processType === 'cut_to_length') {
        console.log('Showing CTL section');
        ctlSection.style.display = 'block';
        addCTLJob(); // Add one default job
    } else if (processType === 'both') {
        console.log('Showing both sections');
        slittingSection.style.display = 'block';
        ctlSection.style.display = 'block';
        addSlittingJob(); // Add one default slitting job
        addCTLJob(); // Add one default CTL job
    }
}

// Initialize event listeners for existing jobs when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Setup existing slitting jobs
    document.querySelectorAll('.slitting-job').forEach(setupSlittingJobEventListeners);
    
    // Setup existing CTL jobs
    document.querySelectorAll('.ctl-job').forEach(setupCTLJobEventListeners);
});
</script>

{% endblock %}